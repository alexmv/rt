%# BEGIN BPS TAGGED BLOCK {{{
%#
%# COPYRIGHT:
%#
%# This software is Copyright (c) 1996-2016 Best Practical Solutions, LLC
%#                                          <sales@bestpractical.com>
%#
%# (Except where explicitly superseded by other copyright notices)
%#
%#
%# LICENSE:
%#
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%#
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%#
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%#
%#
%# CONTRIBUTION SUBMISSION POLICY:
%#
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%#
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%#
%# END BPS TAGGED BLOCK }}}
<tr><td class="label"><&|/l&>Description</&>:</td><td class="value">\
<input name="Description" \
    size="60" \
    value="<% $ARGS{"Description"} || $Scrip->Description || '' %>" />
</td></tr>

<tr><td class="label"><&|/l&>Condition</&>:</td><td class="value">\
<& /Admin/Elements/SelectScripCondition,
    Default => $ARGS{"ScripCondition"} || $Scrip->ConditionObj->Id,
&></td></tr>

% if ($canExecuteCode) {
<tr class="CustomIsApplicableCode <% $editableConditionInitiallyHidden ? 'hidden' : '' %>">
<td class="label"><&|/l&>Condition code</&>:</td><td class="value">\
% my $conditionCode = $ARGS{ CustomIsApplicableCode } || $Scrip->CustomIsApplicableCode() || '';
<textarea cols="80" rows="6" name="CustomIsApplicableCode"><% $conditionCode %></textarea>
</td></tr>
% }

<tr><td class="label"><&|/l&>Action</&>:</td><td class="value">\
<& /Admin/Elements/SelectScripAction,
    Default => $ARGS{"ScripAction"} || $Scrip->ActionObj->Id,
&></td></tr>

% if ($canExecuteCode) {
<tr class="CustomPrepareCode <% $editableActionInitiallyHidden ? 'hidden' : '' %>">
<td class="label"><&|/l&>Prepare code</&>:</td><td class="value">\
% my $prepareCode = $ARGS{ CustomPrepareCode } || $Scrip->CustomPrepareCode() || '';
<textarea cols="80" rows="6" name="CustomPrepareCode"><% $prepareCode %></textarea>
</td></tr>

<tr class="CustomCommitCode <% $editableActionInitiallyHidden ? 'hidden' : '' %>">
<td class="label"><&|/l&>Commit code</&>:</td><td class="value">\
% my $commitCode = $ARGS{ CustomCommitCode } || $Scrip->CustomCommitCode() || '';
<textarea cols="80" rows="6" name="CustomCommitCode"><% $commitCode %></textarea>
</td></tr>
% }

<tr><td class="label"><&|/l&>Template</&>:</td><td class="value">\
<& SelectTemplate,
    Default => $ARGS{"Template"}, Scrip => $Scrip, Queue => $Queue,
&></td></tr>

<script type="text/javascript">
jQuery(function () {
    jQuery("select[name=ScripCondition]").change(function (e) {
        var scripConditionId = parseInt(jQuery(this).val());
        var userEditableIDs = [<% join( ', ', @editableConditionIDs) %>]
        if (userEditableIDs.indexOf(scripConditionId) > -1) {
            jQuery(".CustomIsApplicableCode").removeClass('hidden');
        }else{
            jQuery(".CustomIsApplicableCode").addClass('hidden');
        }
    });

    jQuery("select[name=ScripAction]").change(function (e) {
        var scripConditionId = parseInt(jQuery(this).val());
        var userEditableIDs = [<% join( ', ', @editableActionIDs) %>]
        if (userEditableIDs.indexOf(scripConditionId) > -1) {
            jQuery(".CustomPrepareCode, .CustomCommitCode").removeClass('hidden');
        }else{
            jQuery(".CustomPrepareCode, .CustomCommitCode").addClass('hidden');
        }
    });
});
</script>

<%ARGS>
$Scrip
$Queue => undef
</%ARGS>
<%INIT>

my $canExecuteCode = ($session{CurrentUser}->HasRight(Object => $RT::System, Right => 'ExecuteCode'));

my $editableConditionInitiallyHidden = ($Scrip->ConditionObj->Id) ? !$Scrip->ConditionObj->Condition->IsUserEditable : 1;
my @editableConditionIDs;
my $ScripConditions = RT::ScripConditions->new($session{'CurrentUser'});
$ScripConditions->UnLimit;
while (my $ScripCondition = $ScripConditions->Next) {
    if ($ScripCondition->Condition->IsUserEditable) {
        push @editableConditionIDs, $ScripCondition->Id;
    }
}

my $editableActionInitiallyHidden = ($Scrip->ActionObj->Id) ? !$Scrip->ActionObj->Action->IsUserEditable : 1;
my @editableActionIDs;
my $ScripActions = RT::ScripActions->new($session{'CurrentUser'});
$ScripActions->UnLimit;
while (my $ScripAction = $ScripActions->Next) {
    if ($ScripAction->Action->IsUserEditable) {
        push @editableActionIDs, $ScripAction->Id;
    }
}

</%INIT>
